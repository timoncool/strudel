import{e as d,r as f,f as w,h as g,j as b,k,o as x,q,t as $,u as E,v as A,w as I,x as M}from"./index.CXEd7qFE.js";import{u as _}from"./codemirror.CljggVKv.js";import"./index.Ds4Xb5JZ.js";import"./_commonjsHelpers.BosuxZz1.js";class j{token_types={comment:/^\/\/(.*?)(?=\n|$)/,quotes_double:/^"(.*?)"/,quotes_single:/^'(.*?)'/,open_list:/^\(/,close_list:/^\)/,open_angle:/^</,close_angle:/^>/,open_square:/^\[/,close_square:/^\]/,open_curly:/^\{/,close_curly:/^\}/,number:/^-?[0-9]*\.?[0-9]+/,op:/^[*/:!@%?+\-&]|^\.{2}/,pipe:/^#/,stack:/^[,$]/,or:/^[|]/,plain:/^[a-zA-Z0-9-~_^#]+/};op_precedence=[["*","/",":","!","@","%","?","+","-",".."],["&"]];next_token(e,t=0){for(let n in this.token_types){const r=e.match(this.token_types[n]);if(r){let i={type:n,value:r[0]};return t!==-1&&(i.loc=[t,t+r[0].length]),i}}throw new Error(`mondo: could not match '${e}'`)}tokenize(e,t=0){let n=[],r=t!==-1,i=()=>(t+=e.length-e.trimStart().length,e.trim());for(e=i();e.length>0;){e=i();const s=this.next_token(e,r?t:-1);e=e.slice(s.value.length),t+=s.value.length,n.push(s)}return n}parse(e,t){this.code=e,this.offset=t,this.tokens=this.tokenize(e,t);const n=[];for(;this.tokens.length;)n.push(this.parse_expr());return n.length===0?{type:"list",children:[]}:n.length>1||n[0].type!=="list"?{type:"list",children:this.desugar(n)}:n[0]}parse_expr(){if(!this.tokens[0])throw new Error("unexpected end of file");let e=this.tokens[0]?.type;return e==="open_list"?this.parse_list():e==="open_angle"?this.parse_angle():e==="open_square"?this.parse_square():e==="open_curly"?this.parse_curly():this.consume(e)}split_children(e,t){const n=[];for(;;){let r=e.findIndex(s=>s.type===t);if(r===-1)break;const i=e.slice(0,r);n.push(i),e=e.slice(r+1)}return n.push(e),n}desugar_split(e,t,n){const r=this.split_children(e,t);if(r.length===1)return n(e);const i=r.map(s=>{if(s.length)return s.length===1?s[0]:(s=n(s),{type:"list",children:s})}).filter(Boolean);return[{type:"plain",value:t},...i]}unwrap_children(e){return e.length===1?e[0].children:e}desugar_ops(e,t){for(;;){let n=e.findIndex(u=>u.type==="op"&&t.includes(u.value));if(n===-1)break;const r={type:"plain",value:e[n].value};if(n===e.length-1){e[n]=r;continue}if(n===0){e[n]=r;continue}const i=e[n-1],s=e[n+1];if(i.type==="pipe"){e[n]=r;continue}if(i.type==="op")throw new Error(`got 2 ops in a row: "${i.value}${r.value}"`);if(s.type==="op"){let u=`got 2 ops in a row: "${r.value}${s.value}"`;throw r.value==="-"&&(u+='. you probably want a rest, which is "_" in mondo!'),new Error(u)}const a={type:"list",children:[r,s,i]};e=[...e.slice(0,n-1),a,...e.slice(n+2)],e=this.unwrap_children(e)}return e}get_lambda(e,t){t=this.desugar(t);const n=t.length===1?t[0]:{type:"list",children:t};return[{type:"plain",value:"fn"},{type:"list",children:e},n]}get_range(e,t=[1/0,0]){let n=(r,i)=>[Math.min(r[0],i[0]),Math.max(r[1],i[1])];return e.loc?n(t,e.loc):e.type!=="list"?t:e.children.reduce((r,i)=>{const s=this.get_range(i,r);return n(r,s)},t)}errorhead(e){return`[mondo ${this.get_range(e)?.join(":")||"?"}]`}get_code_snippet(e){const[t,n]=this.get_range(e);return this.code.slice(t-this.offset,n-this.offset)}desugar_pipes(e){let t=this.split_children(e,"pipe");for(;t.length>1;){let[n,r,...i]=t;if(!n.length){const a={type:"plain",value:"_"};return this.get_lambda([a],[a,...e])}const s=n.length>1?{type:"list",children:n}:n[0];t=[[...r,s],...i]}return t[0]}parse_pair(e,t){const n=this.tokens[0].loc?.[0];this.consume(e);const r=[];for(;this.tokens[0]?.type!==t;)r.push(this.parse_expr());const i=this.tokens[0].loc?.[1];this.consume(t);const s={type:"list",children:r};return n!==void 0&&(s.loc=[n,i],s.raw=this.code.slice(n,i)),s}desugar(e,t){return e=t?e.slice(1):e,e=this.desugar_split(e,"stack",n=>this.desugar_split(n,"or",r=>(t&&(r=[{type:"plain",value:t},...r]),this.op_precedence.forEach(i=>{r=this.desugar_ops(r,i)}),r=this.desugar_pipes(r),r))),e}parse_list(){let e=this.parse_pair("open_list","close_list");return e.children=this.desugar(e.children),e}parse_angle(){let e=this.parse_pair("open_angle","close_angle");return e.children.unshift({type:"plain",value:"angle"}),e.children=this.desugar(e.children,"angle"),e}parse_square(){let e=this.parse_pair("open_square","close_square");return e.children.unshift({type:"plain",value:"square"}),e.children=this.desugar(e.children,"square"),e}parse_curly(){let e=this.parse_pair("open_curly","close_curly");return e.children.unshift({type:"plain",value:"curly"}),e.children=this.desugar(e.children,"curly"),e}consume(e){const t=this.tokens.shift();if(t.type!==e)throw new Error(`expected token type ${e}, got ${t.type}`);return t}get_locations(e,t=0){let n=(s,a=[])=>{if(s.type==="list")return s.children.forEach(u=>n(u,a));s.loc&&a.push(s.loc)};const r=this.parse(e,t);let i=[];return n(r,i),i}}class L{constructor({evaluator:e}={}){this.parser=new j,this.evaluator=e,this.assert(typeof e=="function","expected an evaluator function to be passed to new MondoRunner")}assert(e,t){if(!e)throw new Error(t)}run(e,t,n=0){const r=this.parser.parse(e,n);return this.evaluate(r,t)}evaluate_let(e,t){const n=e.children[1].children,r=n.map(u=>u.children[0]),i=n.map(u=>u.children[1]),s=e.children.slice(2),a={type:"list",children:[{type:"plain",value:"fn"},{type:"list",children:r},...s]};return this.evaluate({type:"list",children:[a,...i]},t)}evaluate_def(e,t){if(e.children[1].type==="list"){const i=e.children[1].children.slice(1),s={type:"list",children:[{type:"plain",value:"fn"},{type:"list",children:i},...e.children.slice(2)]};e.children[1]=e.children[1].children[0],e.children[2]=s,e.children=e.children.slice(0,3)}if(e.children.length!==3)throw new Error(`expected "def" to have 3 children, but got ${e.children.length}`);const n=e.children[1].value,r=this.evaluate(e.children[2],t);t[n]=r}evaluate_match(e,t){if(e.children.length<2)return;const[n,...r]=e.children;for(let i=0;i<r.length;++i){const[s,a]=r[i].children;if(s.value==="else")return this.evaluate(a,t);if(this.evaluate(s,t))return this.evaluate(a,t)}}evaluate_if(e,t){if(e.children.length!==4)return;const[n,r,i,s]=e.children,a={type:"list",children:[{type:"plain",value:"match"},{type:"list",children:[r,i]},{type:"list",children:[{type:"plain",value:"else"},s]}]};return this.evaluate_match(a,t)}evaluate_lambda(e,t){const[n,r,...i]=e.children;return(...s)=>{const a=Object.fromEntries(r.children.map((h,p)=>[h.value,s[p]])),u={...t,...a},c=i.map(h=>this.evaluate(h,u));return c[c.length-1]}}evaluate_list(e,t){const r={type:"list",children:e.children.filter(i=>i.type!=="comment").map(i=>this.evaluate(i,t))};return this.evaluator(r,t)}evaluate_leaf(e,t){return e.type==="number"?e.value=Number(e.value):["quotes_double","quotes_single"].includes(e.type)&&(e.value=e.value.slice(1,-1),e.type="string"),this.evaluator(e,t)}evaluate(e,t={}){if(e.type!=="list")return this.evaluate_leaf(e,t);const n=e.children[0]?.value;return n==="fn"?this.evaluate_lambda(e,t):n==="match"?this.evaluate_match(e,t):n==="if"?this.evaluate_if(e,t):n==="let"?this.evaluate_let(e,t):(n==="def"&&this.evaluate_def(e,t),this.evaluate_list(e,t))}}const z=(l,e)=>e.fmap(t=>n=>Array.isArray(t)?[...t,n]:[t,n]).appLeft(l),B=(l,e,t=1)=>Array.from({length:Math.abs(e-l)/t+1},(n,r)=>l<e?l+r*t:l-r*t),R=(l,e)=>e.squeezeBind(t=>l.bind(n=>M(...B(t,n))));let S=(...l)=>l[l.length-1],o={};o.nope=S;o["-"]=(l,e)=>e.early(l);o["+"]=(l,e)=>e.late(l);o._=d;o["~"]=d;o.curly=g;o.square=(...l)=>g(...l).setSteps(1);o.angle=(...l)=>g(...l).pace(1);o["*"]=b;o["/"]=k;o["!"]=x;o["@"]=q;o["%"]=$;o["?"]=E;o["&"]=A;o[":"]=z;o[".."]=R;o.def=()=>d;o.or=(...l)=>I(...l);function C(l,e){const{type:t}=l;if(t==="list"){const{children:s}=l,[a,...u]=s;if(typeof a=="function")return a(...u);if(a.value==="def")return d;const c=a.firstCycle(!0)[0];if(typeof c?.value!=="function")throw new Error(`[mondough] expected function, got "${c?.value}"`);return a.fmap(p=>{if(typeof p!="function")throw new Error(`[mondough] "${p}" is not a function b`);return p(...u)}).innerJoin()}let{value:n}=l;if(t==="plain"&&e[n])return f(e[n]);const r=o[n]??w[n];let i;if(t==="plain"&&typeof r<"u"){if(["!","extend","@","expand","square","angle","all","setcpm","setcps"].includes(n))return r;i=f(r)}else i=f(n);return l.loc&&(i=i.withLoc(l.loc[0],l.loc[1])),i}let y=new L({evaluator:C});function m(l,e=0){return Array.isArray(l)&&(l=l.join("")),y.run(l,void 0,e).markcss("color: var(--caret,--foreground);text-decoration:underline")}let v=(l,e)=>y.parser.get_locations(l,e);const Z=(l,e)=>{const t=`[${l}]`;return m(t,e)};_("mondo",{getLocations:v});const D=l=>m(l,0);_("mondolang",{getLocations:l=>v(l,0)});export{v as getLocations,Z as mondi,m as mondo,D as mondolang};
